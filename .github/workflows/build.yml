name: Build and Package

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          vlc \
          libvlc-dev \
          libgirepository1.0-dev \
          libcairo2-dev \
          libdbus-1-dev \
          libdbus-glib-1-dev \
          pkg-config \
          python3-dev \
          gir1.2-gtk-3.0
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true
    
    - name: Install Python dependencies
      run: uv sync
    
    - name: Build Linux package
      run: |
        uv run flet pack src/main.py \
          -i assets/icon_windows.png \
          --name Deeztracker \
          --debug-console DEBUG_CONSOLE \
          --add-binary "/usr/lib/x86_64-linux-gnu/libvlc.so.5:." \
          --add-binary "/usr/lib/x86_64-linux-gnu/libvlccore.so.9:." \
          --add-data "/usr/lib/x86_64-linux-gnu/girepository-1.0:girepository-1.0" \
          --add-data "/usr/lib/x86_64-linux-gnu/vlc/plugins:vlc_plugins" \
          --hidden-import "gi" \
          --hidden-import "gi.repository.GLib" \
          --hidden-import "dbus.mainloop.glib" \
          -y
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: Deeztracker-Linux
        path: dist/
        retention-days: 30

  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install VLC
      run: |
        choco install vlc -y
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true
    
    - name: Install Python dependencies
      run: uv sync
    
    - name: Build Windows package
      run: |
        uv run flet pack src/main.py `
          -i assets/icon_windows.png `
          --name "Deeztracker" `
          --product-name "Deeztracker" `
          --file-version "0.0.0.1" `
          --add-binary "C:\Program Files\VideoLAN\VLC\libvlc.dll;." `
          --add-binary "C:\Program Files\VideoLAN\VLC\libvlccore.dll;." `
          --add-data "C:\Program Files\VideoLAN\VLC\plugins;plugins" `
          -n "Deeztracker" `
          -y
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: Deeztracker-Windows
        path: dist/
        retention-days: 30
